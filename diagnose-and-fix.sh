#!/bin/bash
# ะะธะฐะณะฝะพััะธะบะฐ ะธ ะธัะฟัะฐะฒะปะตะฝะธะต 502 Bad Gateway

echo "๐ ะะธะฐะณะฝะพััะธะบะฐ ะฟัะพะฑะปะตะผั 502 Bad Gateway..."
echo ""

# 1. ะัะพะฒะตัะบะฐ ะฟะพััะพะฒ
echo "1๏ธโฃ ะัะพะฒะตัะบะฐ ะฟะพััะพะฒ:"
echo "Backend (3001):"
netstat -tlnp | grep 3001 || echo "โ Backend ะฝะต ัะปััะฐะตั ะฟะพัั 3001"
echo ""
echo "Frontend (3000):"
netstat -tlnp | grep 3000 || echo "โ Frontend ะฝะต ัะปััะฐะตั ะฟะพัั 3000"
echo ""
echo "Bot (3003):"
netstat -tlnp | grep 3003 || echo "โ Bot ะฝะต ัะปััะฐะตั ะฟะพัั 3003"
echo ""

# 2. ะัะพะฒะตัะบะฐ PM2
echo "2๏ธโฃ ะกัะฐััั PM2:"
pm2 status
echo ""

# 3. ะัะพะฒะตัะบะฐ ะปะพะณะพะฒ
echo "3๏ธโฃ ะะพัะปะตะดะฝะธะต ะพัะธะฑะบะธ ะฒ ะปะพะณะฐั:"
echo "--- Backend logs ---"
pm2 logs backend --lines 10 --nostream --err
echo ""
echo "--- Frontend logs ---"
pm2 logs frontend --lines 10 --nostream --err
echo ""

# 4. ะัะพะฒะตัะบะฐ nginx
echo "4๏ธโฃ ะกัะฐััั Nginx:"
systemctl status nginx --no-pager | head -10
echo ""

# 5. ะขะตัั ะฟะพะดะบะปััะตะฝะธั
echo "5๏ธโฃ ะขะตัั ะปะพะบะฐะปัะฝัั ะฟะพะดะบะปััะตะฝะธะน:"
echo "Backend health:"
curl -s http://localhost:3001/api/health || echo "โ Backend ะฝะต ะพัะฒะตัะฐะตั"
echo ""
echo "Frontend:"
curl -s -I http://localhost:3000 | head -5 || echo "โ Frontend ะฝะต ะพัะฒะตัะฐะตั"
echo ""

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ง ะะกะะะะะะะะะ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

read -p "ะฅะพัะธัะต ะฟะตัะตะทะฐะฟัััะธัั ัะตัะฒะธัั? (y/n) " -n 1 -r
echo ""
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "๐ ะะตัะตะทะฐะฟััะบ ัะตัะฒะธัะพะฒ..."
    
    # ะััะฐะฝะพะฒะบะฐ ะฒัะตั ะฟัะพัะตััะพะฒ ะฝะฐ ะฟะพััะฐั
    echo "ะัะฒะพะฑะพะถะดะตะฝะธะต ะฟะพััะพะฒ..."
    lsof -ti:3001 | xargs kill -9 2>/dev/null || true
    lsof -ti:3000 | xargs kill -9 2>/dev/null || true
    lsof -ti:3003 | xargs kill -9 2>/dev/null || true
    
    sleep 2
    
    # ะะตัะตะทะฐะฟััะบ ัะตัะตะท PM2
    echo "ะะตัะตะทะฐะฟััะบ ัะตัะตะท PM2..."
    pm2 delete all
    pm2 start ecosystem.config.js
    
    sleep 5
    
    echo ""
    echo "โ ะกะตัะฒะธัั ะฟะตัะตะทะฐะฟััะตะฝั"
    echo ""
    echo "ะะพะฒัะน ััะฐััั:"
    pm2 status
    
    echo ""
    echo "ะัะพะฒะตัะบะฐ ะฟะพััะพะฒ:"
    netstat -tlnp | grep -E '3000|3001|3003'
    
    echo ""
    echo "ะขะตัั backend:"
    curl -s http://localhost:3001/api/health | jq . || curl -s http://localhost:3001/api/health
fi

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ ะกะะะะฃะฎะฉะะ ะจะะะ:"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "1. ะัะพะฒะตัั ะปะพะณะธ ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ:"
echo "   pm2 logs"
echo ""
echo "2. ะัะพะฒะตัั ัะฐะนั:"
echo "   https://megapenis.work.gd"
echo ""
echo "3. ะัะปะธ ะฒัั ะตัั 502, ะฟัะพะฒะตัั nginx ะปะพะณะธ:"
echo "   tail -f /var/log/nginx/megapenis-error.log"
echo ""
echo "4. ะัะปะธ backend ะฝะต ะทะฐะฟััะบะฐะตััั, ะฟัะพะฒะตัั .env:"
echo "   cat backend/.env"
echo ""
