# Ğ¡ĞºÑ€Ğ¸Ğ¿Ñ‚ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ²ÑĞµÑ… KEY_ID Ğ´Ğ»Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ (PowerShell)
# Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: .\scripts\generate-key-ids.ps1

Write-Host "`nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
Write-Host "â•‘      ğŸ” Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ‚Ğ¾Ñ€ Key IDs Ğ´Ğ»Ñ Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²              â•‘" -ForegroundColor Cyan
Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n" -ForegroundColor Cyan

# Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾Ğ³Ğ¾ ĞºĞ»ÑÑ‡Ğ°
function New-SecureKey {
    param([int]$Length = 32)
    $bytes = New-Object byte[] $Length
    $rng = [System.Security.Cryptography.RNGCryptoServiceProvider]::new()
    $rng.GetBytes($bytes)
    $rng.Dispose()
    return [System.BitConverter]::ToString($bytes).Replace("-", "").ToLower()
}

# Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ base64 ÑĞµĞºÑ€ĞµÑ‚Ğ°
function New-Base64Secret {
    param([int]$Length = 32)
    $bytes = New-Object byte[] $Length
    $rng = [System.Security.Cryptography.RNGCryptoServiceProvider]::new()
    $rng.GetBytes($bytes)
    $rng.Dispose()
    return [Convert]::ToBase64String($bytes)
}

# Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ²ÑĞµÑ… Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ñ… Key IDs
$keyIds = @(
    @{ Name = "SECURITY_LOGS_KEY_ID"; Description = "Ğ¨Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ»Ğ¾Ğ³Ğ¾Ğ² Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸" }
    @{ Name = "SBOM_SIGNING_KEY_ID"; Description = "ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑÑŒ ÑĞ¿Ğ¸ÑĞºĞ° ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¾Ğ² (SBOM)" }
    @{ Name = "COMMUNICATION_KEY_ID"; Description = "Ğ¨Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ¼ÑƒĞ½Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¹" }
    @{ Name = "WEBSOCKET_KEY_ID"; Description = "Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° WebSocket ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğ¹" }
    @{ Name = "BACKUP_KEY_ID"; Description = "Ğ¨Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ±ÑĞºĞ°Ğ¿Ğ¾Ğ²" }
    @{ Name = "STORAGE_KEY_ID"; Description = "Ğ¨Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ² Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğµ" }
    @{ Name = "LOG_KEY_ID"; Description = "Ğ¨Ğ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ñ… Ğ»Ğ¾Ğ³Ğ¾Ğ²" }
)

# Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ ÑĞµĞºÑ€ĞµÑ‚Ñ‹
$additionalSecrets = @(
    @{ Name = "JWT_SECRET"; Description = "JWT Ñ‚Ğ¾ĞºĞµĞ½Ñ‹"; Length = 64; Type = "base64" }
    @{ Name = "JWT_REFRESH_SECRET"; Description = "JWT refresh Ñ‚Ğ¾ĞºĞµĞ½Ñ‹"; Length = 64; Type = "base64" }
    @{ Name = "SESSION_SECRET"; Description = "Ğ¡ĞµÑÑĞ¸Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹"; Length = 32; Type = "base64" }
    @{ Name = "COOKIE_SECRET"; Description = "Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° cookies"; Length = 32; Type = "base64" }
)

Write-Host "ğŸ“ Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ĞºĞ»ÑÑ‡ĞµĞ¹...`n" -ForegroundColor Yellow

# Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ²ÑĞµ ĞºĞ»ÑÑ‡Ğ¸
$generatedKeys = @{}

# Key IDs
foreach ($key in $keyIds) {
    $value = New-SecureKey -Length 32
    $generatedKeys[$key.Name] = $value
    Write-Host "âœ“ $($key.Name.PadRight(25)) - $($key.Description)" -ForegroundColor Green
}

Write-Host ""

# Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ ÑĞµĞºÑ€ĞµÑ‚Ñ‹
foreach ($secret in $additionalSecrets) {
    $value = New-Base64Secret -Length $secret.Length
    $generatedKeys[$secret.Name] = $value
    Write-Host "âœ“ $($secret.Name.PadRight(25)) - $($secret.Description)" -ForegroundColor Green
}

Write-Host "`nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n" -ForegroundColor Cyan

# Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ Ğ´Ğ»Ñ .env Ñ„Ğ°Ğ¹Ğ»Ğ°
$envContent = @"
# ============================================
# Key IDs Ğ´Ğ»Ñ ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¸ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
# Ğ¡Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾: $(Get-Date -Format "dd.MM.yyyy HH:mm:ss")
# ============================================

# ĞšĞ»ÑÑ‡Ğ¸ ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
$($keyIds | ForEach-Object { "$($_.Name)=$($generatedKeys[$_.Name])" } | Out-String)
# JWT Ğ¸ ÑĞµÑÑĞ¸Ğ¸
$($additionalSecrets | ForEach-Object { "$($_.Name)=$($generatedKeys[$_.Name])" } | Out-String)
# Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸
ENABLE_CSRF_PROTECTION=true
HASH_ALGORITHM=sha256
ENCRYPTION_ALGORITHM=aes-256-gcm
"@

Write-Host "ğŸ“‹ ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ ÑÑ‚Ñ€Ğ¾ĞºĞ¸ Ğ² Ğ²Ğ°Ñˆ .env Ñ„Ğ°Ğ¹Ğ»:`n" -ForegroundColor Cyan
Write-Host $envContent

# Ğ¡Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµĞ¼, ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ»Ğ¸ Ğ² Ñ„Ğ°Ğ¹Ğ»
$response = Read-Host "`nĞ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ² Ñ„Ğ°Ğ¹Ğ» .env.keys? (y/n)"
if ($response -match "^[yYĞ´Ğ”]") {
    $filePath = Join-Path $PSScriptRoot "..\\.env.keys"
    Set-Content -Path $filePath -Value $envContent -Encoding UTF8
    Write-Host "`nâœ“ ĞšĞ»ÑÑ‡Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹ Ğ² $filePath" -ForegroundColor Green
    Write-Host "`nâš ï¸  Ğ’ĞĞ–ĞĞ:" -ForegroundColor Yellow
    Write-Host "   1. Ğ¡ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ .env.keys Ğ² Ğ²Ğ°Ñˆ .env Ñ„Ğ°Ğ¹Ğ»"
    Write-Host "   2. Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğµ .env.keys Ğ¿Ğ¾ÑĞ»Ğµ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ"
    Write-Host "   3. Ğ£Ğ±ĞµĞ´Ğ¸Ñ‚ĞµÑÑŒ, Ñ‡Ñ‚Ğ¾ .env Ğ² .gitignore"
} else {
    Write-Host "`nâœ“ Ğ¡ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ ĞºĞ»ÑÑ‡Ğ¸ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ Ğ¸Ğ· Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ° Ğ²Ñ‹ÑˆĞµ" -ForegroundColor Cyan
}

Write-Host "`nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Green
Write-Host "â•‘                     âœ“ Ğ“ĞĞ¢ĞĞ’Ğ!                            â•‘" -ForegroundColor Green
Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n" -ForegroundColor Green

Write-Host "âš ï¸  ĞŸĞ Ğ•Ğ”Ğ£ĞŸĞ Ğ•Ğ–Ğ”Ğ•ĞĞ˜Ğ¯ Ğ‘Ğ•Ğ—ĞĞŸĞĞ¡ĞĞĞ¡Ğ¢Ğ˜:" -ForegroundColor Red
Write-Host "   â€¢ ĞĞ˜ĞšĞĞ“Ğ”Ğ Ğ½Ğµ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚ÑŒÑ‚Ğµ .env Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ² Git"
Write-Host "   â€¢ Ğ¥Ñ€Ğ°Ğ½Ğ¸Ñ‚Ğµ ĞºĞ»ÑÑ‡Ğ¸ Ğ² Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾Ğ¼ Ğ¼ĞµÑÑ‚Ğµ"
Write-Host "   â€¢ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ñ€Ğ°Ğ·Ğ½Ñ‹Ğµ ĞºĞ»ÑÑ‡Ğ¸ Ğ´Ğ»Ñ dev/prod"
Write-Host "   â€¢ Ğ ĞµĞ³ÑƒĞ»ÑÑ€Ğ½Ğ¾ Ñ€Ğ¾Ñ‚Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ ĞºĞ»ÑÑ‡Ğ¸ Ğ² Ğ¿Ñ€Ğ¾Ğ´Ğ°ĞºÑˆĞµĞ½Ğµ`n"

