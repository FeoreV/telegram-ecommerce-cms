# AppArmor profile for BotRT Backend Container
# Provides fine-grained access control for maximum security

#include <tunables/global>

profile botrt-backend flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openssl>
  #include <abstractions/ssl_certs>

  # Capabilities (minimal set)
  capability setuid,
  capability setgid,
  capability chown,
  capability dac_override,
  capability net_bind_service,

  # Deny dangerous capabilities
  deny capability sys_admin,
  deny capability sys_ptrace,
  deny capability sys_module,
  deny capability sys_rawio,
  deny capability sys_boot,
  deny capability sys_time,
  deny capability mknod,
  deny capability mac_admin,
  deny capability mac_override,

  # Network access
  network inet tcp,
  network inet udp,
  network inet6 tcp,
  network inet6 udp,
  network unix stream,
  network unix dgram,

  # Deny raw sockets and packet sockets
  deny network raw,
  deny network packet,

  # File system access (read-only root filesystem)
  / r,
  /app/** r,
  /app/dist/** r,
  /app/node_modules/** r,
  /app/config/** r,
  /app/certs/** r,

  # Writable directories (minimal)
  /tmp/** rw,
  /var/tmp/** rw,
  /app/logs/** rw,
  /app/uploads/** rw,

  # System files (read-only)
  /etc/passwd r,
  /etc/group r,
  /etc/nsswitch.conf r,
  /etc/hosts r,
  /etc/resolv.conf r,
  /etc/ssl/certs/** r,
  /etc/ca-certificates/** r,
  /usr/share/ca-certificates/** r,

  # Proc filesystem (limited)
  @{PROC}/*/fd/ r,
  @{PROC}/*/stat r,
  @{PROC}/*/status r,
  @{PROC}/*/cmdline r,
  @{PROC}/sys/kernel/version r,
  @{PROC}/uptime r,
  @{PROC}/loadavg r,
  @{PROC}/meminfo r,
  @{PROC}/cpuinfo r,

  # Deny access to sensitive proc files
  deny @{PROC}/kcore r,
  deny @{PROC}/kmsg r,
  deny @{PROC}/mem r,
  deny @{PROC}/sysrq-trigger rw,
  deny @{PROC}/*/maps r,
  deny @{PROC}/*/environ r,

  # System directories (read-only)
  /sys/devices/system/cpu/ r,
  /sys/devices/system/cpu/cpu*/cache/index*/size r,
  /sys/devices/system/node/ r,
  /sys/devices/system/node/node*/meminfo r,

  # Deny access to sensitive system directories
  deny /sys/firmware/** rw,
  deny /sys/kernel/** rw,
  deny /sys/module/** rw,

  # Library access
  /lib/** mr,
  /lib64/** mr,
  /usr/lib/** mr,
  /usr/local/lib/** mr,

  # Node.js specific
  /usr/bin/node rix,
  /usr/local/bin/node rix,

  # Deny execution of other binaries
  deny /bin/** x,
  deny /sbin/** x,
  deny /usr/bin/** x,
  deny /usr/sbin/** x,
  deny /usr/local/bin/** x,
  deny /usr/local/sbin/** x,

  # Allow only Node.js binary
  /usr/bin/node ix,
  /usr/local/bin/node ix,

  # Device access (minimal)
  /dev/null rw,
  /dev/zero r,
  /dev/random r,
  /dev/urandom r,

  # Deny access to dangerous devices
  deny /dev/mem rw,
  deny /dev/kmem rw,
  deny /dev/port rw,
  deny /dev/raw/** rw,

  # Signal handling
  signal receive peer=unconfined,
  signal send peer=unconfined,

  # Deny ptrace
  deny ptrace,

  # Mount operations (deny all)
  deny mount,
  deny umount,
  deny pivot_root,

  # Change profile rules
  deny change_profile,
  deny change_onexec,

  # Unix domain sockets
  unix (connect, receive, send) type=stream peer=(label=unconfined),
  unix (connect, receive, send) type=dgram peer=(label=unconfined),

  # Specific application rules
  
  # Node.js runtime
  /app/dist/index.js r,
  /app/package.json r,
  /app/node_modules/** r,

  # Configuration files
  /app/config/*.json r,
  /app/config/*.yaml r,
  /app/config/*.yml r,

  # SSL/TLS certificates
  /app/certs/*.pem r,
  /app/certs/*.crt r,
  /app/certs/*.key r,

  # Log files
  /app/logs/*.log rw,
  /app/logs/*.json rw,

  # Upload directory
  /app/uploads/** rw,

  # Temporary files
  /tmp/** rw,
  /var/tmp/** rw,

  # Database connections (via network)
  # PostgreSQL default port
  network inet stream to any port 5432,
  # Redis default port  
  network inet stream to any port 6379,
  # Vault default port
  network inet stream to any port 8200,

  # HTTP/HTTPS outbound (for APIs)
  network inet stream to any port 80,
  network inet stream to any port 443,

  # DNS resolution
  network inet dgram to any port 53,
  network inet6 dgram to any port 53,

  # Application listening port
  network inet stream to any port 3000,

  # Syslog
  network unix dgram to any path /dev/log,

  # Time synchronization
  network inet dgram to any port 123,

  # Health check script
  /app/healthcheck.sh rix,
  /bin/sh ix,
  /usr/bin/curl rix,

  # Environment access
  owner @{PROC}/@{pid}/environ r,

  # Deny everything else
  deny /** w,
  deny /** x,

  # Allow specific writes only
  /app/logs/** w,
  /app/uploads/** w,
  /tmp/** w,
  /var/tmp/** w,

  # File locking
  /app/logs/*.lock rw,
  /tmp/*.lock rw,
}
