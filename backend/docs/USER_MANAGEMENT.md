# Система управления пользователями

## Обзор

Полнофункциональная система управления пользователями с расширенными возможностями контроля, мониторинга и администрирования пользователей ботов магазинов.

## Функциональность

### 1. Просмотр пользователей

#### GET /api/users
Получить список всех пользователей с фильтрацией и пагинацией.

**Query параметры:**
- `page` (number, optional) - Номер страницы (по умолчанию: 1)
- `limit` (number, optional) - Количество записей на странице (по умолчанию: 20)
- `role` (string, optional) - Фильтр по роли: OWNER, ADMIN, VENDOR, CUSTOMER
- `search` (string, optional) - Поиск по имени, username, email, Telegram ID
- `isActive` (boolean, optional) - Фильтр по статусу активности

**Ответ:**
```json
{
  "users": [
    {
      "id": "user_id",
      "telegramId": "123456789",
      "username": "username",
      "firstName": "Имя",
      "lastName": "Фамилия",
      "email": "user@example.com",
      "phone": "+1234567890",
      "role": "CUSTOMER",
      "isActive": true,
      "createdAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z",
      "_count": {
        "orders": 5,
        "ownedStores": 0,
        "managedStores": 0
      },
      "stores": {
        "owned": [],
        "admin": [],
        "vendor": []
      }
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 100,
    "totalPages": 5
  }
}
```

### 2. Детальная информация о пользователе

#### GET /api/users/:id/detailed
Получить детальную информацию о пользователе со статистикой.

**Ответ:**
```json
{
  "user": {
    "id": "user_id",
    "telegramId": "123456789",
    "username": "username",
    "firstName": "Имя",
    "lastName": "Фамилия",
    "role": "CUSTOMER",
    "isActive": true,
    "stores": {
      "owned": [],
      "admin": [],
      "vendor": []
    },
    "statistics": {
      "totalOrders": 10,
      "totalStores": 2,
      "activeSessions": 1,
      "notifications": 5,
      "adminActions": 0,
      "recentActivity": 15,
      "orders": [
        {
          "status": "DELIVERED",
          "count": 8,
          "totalAmount": 5000
        }
      ]
    },
    "orders": [],
    "sessions": []
  }
}
```

### 3. Активность пользователя

#### GET /api/users/:id/activity
Получить историю активности пользователя.

**Query параметры:**
- `page` (number, optional) - Номер страницы
- `limit` (number, optional) - Количество записей

**Ответ:**
```json
{
  "activities": [
    {
      "id": "activity_id",
      "action": "PRODUCT_CREATED",
      "details": "{}",
      "createdAt": "2024-01-01T00:00:00.000Z",
      "store": {
        "id": "store_id",
        "name": "Магазин",
        "slug": "store"
      }
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 50,
    "totalPages": 3
  }
}
```

### 4. Статистика по ролям

#### GET /api/users/statistics
Получить общую статистику пользователей.

**Ответ:**
```json
{
  "roleDistribution": [
    {
      "role": "CUSTOMER",
      "count": 100,
      "percentage": 80
    },
    {
      "role": "VENDOR",
      "count": 15,
      "percentage": 12
    }
  ],
  "summary": {
    "totalUsers": 125,
    "activeUsers": 120,
    "inactiveUsers": 5,
    "recentRegistrations": 10
  }
}
```

### 5. Управление ролями

#### PUT /api/users/:id/role
Изменить роль пользователя (только OWNER).

**Body:**
```json
{
  "role": "ADMIN",
  "storeAssignments": [
    {
      "storeId": "store_id",
      "role": "ADMIN"
    }
  ]
}
```

**Ответ:**
```json
{
  "user": { ... },
  "message": "User role updated successfully"
}
```

### 6. Блокировка пользователя

#### POST /api/users/:id/ban
Заблокировать пользователя (OWNER и ADMIN).

**Body:**
```json
{
  "reason": "Нарушение правил использования"
}
```

**Функциональность:**
- Деактивирует пользователя (isActive = false)
- Отзывает все активные сессии
- Создает запись в логах администратора
- Отправляет уведомление пользователю

**Ответ:**
```json
{
  "user": { ... },
  "message": "User banned successfully"
}
```

### 7. Разблокировка пользователя

#### POST /api/users/:id/unban
Разблокировать пользователя (OWNER и ADMIN).

**Функциональность:**
- Активирует пользователя (isActive = true)
- Создает запись в логах администратора
- Отправляет уведомление пользователю

**Ответ:**
```json
{
  "user": { ... },
  "message": "User unbanned successfully"
}
```

### 8. Удаление пользователя

#### DELETE /api/users/:id
Удалить пользователя (только OWNER).

**Ограничения:**
- Нельзя удалить пользователя, владеющего магазинами
- Нельзя удалить себя

**Ответ:**
```json
{
  "message": "User deleted successfully"
}
```

### 9. Массовые действия

#### POST /api/users/bulk-action
Выполнить массовое действие над пользователями (только OWNER).

**Body:**
```json
{
  "action": "ban",
  "userIds": ["user_id_1", "user_id_2"],
  "data": {
    "role": "VENDOR"
  }
}
```

**Доступные действия:**
- `ban` - Заблокировать пользователей
- `unban` - Разблокировать пользователей
- `changeRole` - Изменить роль (требуется data.role)
- `delete` - Удалить пользователей

**Ответ:**
```json
{
  "message": "Bulk action ban completed successfully",
  "affectedCount": 2
}
```

### 10. Назначение в магазин

#### POST /api/users/assign-store
Назначить пользователя администратором или продавцом магазина.

**Body:**
```json
{
  "userId": "user_id",
  "storeId": "store_id",
  "role": "ADMIN"
}
```

### 11. Удаление из магазина

#### DELETE /api/users/remove-store
Удалить пользователя из магазина.

**Body:**
```json
{
  "userId": "user_id",
  "storeId": "store_id",
  "role": "ADMIN"
}
```

## Права доступа

### Уровни доступа

1. **OWNER** (Владелец):
   - Полный доступ ко всем функциям
   - Может изменять роли
   - Может удалять пользователей
   - Может выполнять массовые действия

2. **ADMIN** (Администратор):
   - Просмотр пользователей
   - Блокировка/разблокировка пользователей (кроме OWNER)
   - Просмотр статистики
   - Не может изменять роли
   - Не может удалять пользователей

3. **VENDOR** (Продавец):
   - Нет доступа к управлению пользователями

4. **CUSTOMER** (Клиент):
   - Может просматривать только свой профиль

### Ограничения

- Нельзя модифицировать собственный аккаунт
- ADMIN не может модифицировать OWNER
- Нельзя удалить пользователей, владеющих магазинами
- Массовые действия защищают аккаунты OWNER

## Frontend компоненты

### UsersPage

Главная страница управления пользователями с функциями:

**Основные возможности:**
- Таблица со списком пользователей
- Фильтрация по роли, статусу, поиск
- Пагинация
- Статистические карточки
- Массовый выбор пользователей

**Действия над пользователями:**
- Просмотр детальной информации
- Изменение роли (OWNER)
- Блокировка/разблокировка
- Удаление (OWNER)
- Массовые действия (OWNER)

**Модальные окна:**
1. **Детали пользователя** - вкладки:
   - Основная информация
   - Статистика (заказы, магазины, сессии)
   - История активности

2. **Блокировка** - с указанием причины

3. **Изменение роли** - выбор новой роли

4. **Удаление** - подтверждение с предупреждением

**Массовые действия:**
- Блокировка выбранных
- Разблокировка выбранных
- Удаление выбранных (OWNER)

### Статистика

На странице отображаются карточки:
- Всего пользователей
- Активных пользователей
- Заблокированных пользователей
- Новых за неделю

## Безопасность

### Логирование

Все критические действия логируются в `AdminLog`:
- Блокировка/разблокировка
- Изменение ролей
- Удаление пользователей
- Массовые действия

### Уведомления

Пользователи получают уведомления при:
- Блокировке аккаунта (с причиной)
- Разблокировке аккаунта
- Изменении роли
- Назначении в магазин

### Сессии

При блокировке пользователя:
- Отзываются все активные сессии
- Пользователь не сможет войти в систему
- Токены становятся недействительными

## Использование

### Просмотр пользователей

```typescript
import { userService } from '../services/userService'

const loadUsers = async () => {
  const response = await userService.getUsers({
    page: 1,
    limit: 20,
    role: 'CUSTOMER',
    search: 'иван',
    isActive: true
  })
  console.log(response.users)
}
```

### Блокировка пользователя

```typescript
const banUser = async (userId: string) => {
  await userService.banUser(userId, 'Нарушение правил')
  // Пользователь заблокирован и уведомлен
}
```

### Массовые действия

```typescript
const bulkBan = async (userIds: string[]) => {
  await userService.bulkUserAction('ban', userIds)
  // Все пользователи заблокированы
}
```

### Получение детальной информации

```typescript
const getUserDetails = async (userId: string) => {
  const response = await userService.getUserDetailed(userId)
  console.log(response.user.statistics)
}
```

## Рекомендации

1. **Регулярный мониторинг**: Проверяйте статистику пользователей для выявления аномалий
2. **Документирование блокировок**: Всегда указывайте причину при блокировке
3. **Проверка перед удалением**: Убедитесь, что пользователь не владеет магазинами
4. **Осторожность с массовыми действиями**: Проверяйте список перед выполнением
5. **Мониторинг активности**: Отслеживайте подозрительную активность через историю

## Интеграция с ботами

Пользователи, заблокированные в системе:
- Не могут использовать Telegram ботов магазинов
- Получают уведомление о блокировке в Telegram
- Не могут создавать новые заказы
- Теряют доступ к личному кабинету

## Примеры использования

### Пример 1: Блокировка спамера

```typescript
// Найти пользователя
const users = await userService.getUsers({ search: 'spam_user' })
const spammer = users.users[0]

// Заблокировать с причиной
await userService.banUser(spammer.id, 'Спам и рассылка нежелательных сообщений')

// Пользователь получит уведомление в Telegram
```

### Пример 2: Повышение роли

```typescript
// Повысить клиента до продавца
await userService.updateRole(userId, 'VENDOR', [
  { storeId: 'store1', role: 'VENDOR' }
])

// Пользователь получит права продавца в указанном магазине
```

### Пример 3: Массовая очистка неактивных

```typescript
// Получить неактивных пользователей старше года
const inactiveUsers = await userService.getUsers({
  isActive: false,
  // Дополнительная фильтрация по дате
})

// Удалить (только если не владеют магазинами)
await userService.bulkUserAction('delete', inactiveUserIds)
```

## Troubleshooting

### Проблема: Не могу удалить пользователя
**Решение**: Проверьте, не владеет ли пользователь магазинами. Сначала передайте владение магазином другому пользователю.

### Проблема: Массовое действие не применяется к некоторым пользователям
**Решение**: Проверьте роли пользователей. Аккаунты OWNER защищены от массовых действий.

### Проблема: Пользователь не получает уведомление о блокировке
**Решение**: Проверьте настройки Telegram бота и убедитесь, что у пользователя есть активная сессия в боте.

## API Reference

Полная документация API доступна в Swagger UI:
```
http://82.147.84.78:5000/api-docs
```

## Changelog

### v1.0.0 (Текущая версия)
- ✅ Просмотр списка пользователей с фильтрацией
- ✅ Детальная информация о пользователе
- ✅ История активности пользователя
- ✅ Блокировка/разблокировка пользователей
- ✅ Изменение ролей
- ✅ Удаление пользователей
- ✅ Массовые действия
- ✅ Назначение в магазины
- ✅ Статистика по пользователям
- ✅ Уведомления о действиях
- ✅ Логирование всех действий

